flowchart TB

    %% â”€â”€ External â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    AISS(["ðŸ›°ï¸ AISstream.io\nWebSocket"])
    CLIENT(["ðŸ‘¤ API Client"])
    BROWSER(["ðŸŒ Browser / Map\nEventSource"])

    %% â”€â”€ FastAPI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    subgraph APP["  FastAPI  "]
        direction TB

        subgraph INGEST["Ingestion Service  (asyncio background)"]
            direction TB

            WS["WebSocket\nconnect_loop\n+ reconnect back-off"]
            PARSE["Parse message\n_parse_position()\n_parse_static()"]
            BBOX{"Inside\nfixed zone\nbbox?"}
            DISCARD["ðŸ—‘ï¸ discard"]

            WS --> PARSE --> BBOX
            BBOX -- "No" --> DISCARD
            BBOX -- "Yes" --> SPLIT

            SPLIT((" "))
            SPLIT --> BATCH["Batch buffer\nBATCH_SIZE = 50\nor every 1 second"]
            SPLIT --> BCAST["broadcast(row)\nâ†’ all live queues"]

            MATLOOP["materialise_loop\nevery 60 sec\ncall flush_1min_from_agg()"]
        end

        subgraph API["REST + SSE Endpoints  /api/v1"]
            direction LR
            EP1["GET /vessels\nGET /vessels/{mmsi}\nGET /vessels/{mmsi}/track"]
            EP2["GET /positions/recent\nlast 24 h Â· 1-sec table"]
            EP3["GET /positions/history\nany range Â· 1-min table"]
            EP4["GET /live\nSSE  text/event-stream\nper-client asyncio.Queue"]
            EP5["GET /stats\nGET /health"]
        end
    end

    %% â”€â”€ TimescaleDB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    subgraph DB["  TimescaleDB  "]
        direction TB

        T1[("positions_1sec\nHypertable Â· 1-hr chunks\nEvery message stored\nRetention: 24 hours\nCompression: after 2 hrs")]
        T2[("positions_1min\nHypertable Â· 7-day chunks\nOne row per vessel/minute\nKept forever\nCompression: after 7 days")]
        T3[("vessels\nStatic info\nupserted on msg 5/24")]
        AGG(["positions_1min_agg\nContinuous aggregate\ntime_bucket('1 minute')\nRefreshes every 1 min\nlast(lat), last(lon), count(*)"])

        T1 -- "feeds" --> AGG
        AGG -- "flush_1min_from_agg()\nevery 60 sec" --> T2
    end

    %% â”€â”€ Data flows â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    AISS -- "WebSocket\nPosition + Static msgs" --> WS

    BATCH -- "INSERT batch\nevery 1 sec / 50 rows" --> T1
    BATCH -- "upsert static" --> T3

    BCAST -- "put_nowait(row)\ndrop if queue full" --> QUEUES["Per-client\nasyncio.Queue"]
    QUEUES -- "SSE event\ndata: {JSON}\\n\\n" --> BROWSER

    CLIENT -- "REST" --> API
    EP1 -- "SELECT" --> T3
    EP2 -- "SELECT" --> T1
    EP3 -- "SELECT" --> T2
    EP4 -- "subscribe_live()\nunsubscribe_live()" --> QUEUES

    %% â”€â”€ Config note â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ENV["ðŸ“„ .env\nZONE_NAME\nZONE_LAT_MIN / MAX\nZONE_LON_MIN / MAX\nHIGH_FREQ_RETENTION_HOURS=24\nBATCH_SIZE=50\nBATCH_TIMEOUT_SEC=1.0"]
    ENV -. "fixed at startup" .-> BBOX

    %% â”€â”€ Styling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    classDef external  fill:#1a1a2e,stroke:#e94560,color:#fff,font-weight:bold
    classDef table     fill:#16213e,stroke:#0f3460,color:#a8dadc
    classDef agg       fill:#0d2137,stroke:#457b9d,color:#a8dadc,stroke-dasharray:4
    classDef service   fill:#0f3460,stroke:#e94560,color:#fff
    classDef decision  fill:#533483,stroke:#e94560,color:#fff
    classDef discard   fill:#2d1b1b,stroke:#e94560,color:#ff6b6b
    classDef config    fill:#1a2e1a,stroke:#52b788,color:#b7e4c7
    classDef queue     fill:#2d2200,stroke:#f4a261,color:#ffd166

    class AISS,CLIENT,BROWSER external
    class T1,T2,T3 table
    class AGG agg
    class WS,PARSE,BATCH,BCAST,MATLOOP service
    class BBOX decision
    class DISCARD discard
    class ENV config
    class QUEUES queue
