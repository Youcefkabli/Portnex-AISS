<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AIS Live Table</title>
  <style>
    :root {
      color-scheme: light dark;
      font-family: Arial, Helvetica, sans-serif;
    }
    body {
      margin: 0;
      padding: 20px;
      background: #0f172a;
      color: #e2e8f0;
    }
    h1 {
      margin: 0 0 8px;
      font-size: 1.35rem;
    }
    .meta {
      margin: 0 0 16px;
      color: #94a3b8;
      font-size: 0.95rem;
    }
    .status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 6px;
      font-weight: 600;
      margin-left: 8px;
      background: #1e293b;
      color: #f8fafc;
    }
    .status.connected {
      background: #14532d;
      color: #dcfce7;
    }
    .status.disconnected {
      background: #7f1d1d;
      color: #fee2e2;
    }
    .table-wrap {
      overflow-x: auto;
      border: 1px solid #334155;
      border-radius: 8px;
      background: #111827;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1500px;
    }
    th, td {
      padding: 10px 12px;
      border-bottom: 1px solid #1f2937;
      text-align: left;
      white-space: nowrap;
      font-size: 0.92rem;
    }
    th {
      position: sticky;
      top: 0;
      background: #1e293b;
      color: #f8fafc;
      font-weight: 600;
    }
    tr:hover td {
      background: #0b1220;
    }
    .empty {
      color: #94a3b8;
      margin-top: 12px;
      font-size: 0.95rem;
    }
  </style>
</head>
<body>
  <h1>AIS Live Positions</h1>
  <p class="meta">
    Streaming from <code>/api/v1/live</code>
    <span id="conn-status" class="status disconnected">Disconnected</span>
    Â· <a href="/map" style="color:#93c5fd;">Map View</a>
  </p>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Time (UTC)</th>
          <th>MMSI</th>
          <th>Vessel Name</th>
          <th>IMO</th>
          <th>Callsign</th>
          <th>Ship Type</th>
          <th>Destination</th>
          <th>ETA</th>
          <th>Draught</th>
          <th>Latitude</th>
          <th>Longitude</th>
          <th>Speed</th>
          <th>Course</th>
          <th>Heading</th>
          <th>Nav Status</th>
          <th>ROT</th>
          <th>Msg Type</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>
  <p id="empty" class="empty">Waiting for live data...</p>

  <script>
    const maxRows = 100;
    const byMmsi = new Map();
    const vesselByMmsi = new Map();
    const vesselFetchInFlight = new Set();
    const rowsEl = document.getElementById("rows");
    const emptyEl = document.getElementById("empty");
    const statusEl = document.getElementById("conn-status");

    let zoneBbox = null;
    const inZone = (lat, lon) => {
      if (zoneBbox == null) return true;
      const latMin = zoneBbox.lat_min;
      const latMax = zoneBbox.lat_max;
      const lonMin = zoneBbox.lon_min;
      const lonMax = zoneBbox.lon_max;
      return Number.isFinite(lat) && Number.isFinite(lon) &&
        lat >= latMin && lat <= latMax && lon >= lonMin && lon <= lonMax;
    };

    const escapeHtml = (value) => String(value)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");

    const asText = (value) => {
      if (value === null || value === undefined || value === "") {
        return "-";
      }
      return escapeHtml(value);
    };

    const fmtNumber = (value, digits = 5) => {
      if (value === null || value === undefined || Number.isNaN(Number(value))) {
        return "-";
      }
      return Number(value).toFixed(digits);
    };

    const fmtTime = (raw) => {
      if (!raw) {
        return "-";
      }
      const date = new Date(raw);
      if (Number.isNaN(date.getTime())) {
        return asText(raw);
      }
      return date.toISOString().replace("T", " ").replace("Z", "");
    };

    const render = () => {
      const rows = Array.from(byMmsi.values())
        .sort((a, b) => new Date(b.time).getTime() - new Date(a.time).getTime())
        .slice(0, maxRows);

      rowsEl.innerHTML = rows.map((row) => `
        ${(() => {
          const vessel = vesselByMmsi.get(String(row.mmsi)) || {};
          return `
            <tr>
              <td>${fmtTime(row.time)}</td>
              <td>${asText(row.mmsi)}</td>
              <td>${asText(vessel.name)}</td>
              <td>${asText(vessel.imo)}</td>
              <td>${asText(vessel.callsign)}</td>
              <td>${asText(vessel.ship_type_text || vessel.ship_type)}</td>
              <td>${asText(vessel.destination)}</td>
              <td>${asText(vessel.eta)}</td>
              <td>${fmtNumber(vessel.draught, 2)}</td>
              <td>${fmtNumber(row.latitude)}</td>
              <td>${fmtNumber(row.longitude)}</td>
              <td>${fmtNumber(row.speed, 2)}</td>
              <td>${fmtNumber(row.course, 2)}</td>
              <td>${asText(row.heading)}</td>
              <td>${asText(row.nav_status)}</td>
              <td>${fmtNumber(row.rot, 2)}</td>
              <td>${asText(row.msg_type)}</td>
            </tr>
          `;
        })()}
      `).join("");

      emptyEl.style.display = rows.length ? "none" : "block";
    };

    const setConnected = (connected) => {
      statusEl.textContent = connected ? "Connected" : "Disconnected";
      statusEl.classList.toggle("connected", connected);
      statusEl.classList.toggle("disconnected", !connected);
    };

    fetch("/api/v1/stats")
      .then((r) => r.ok ? r.json() : null)
      .then((stats) => {
        if (stats && stats.bbox) {
          zoneBbox = stats.bbox;
        }
      })
      .catch(() => {});

    const es = new EventSource("/api/v1/live");

    es.onopen = () => setConnected(true);

    es.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);
        if (data && data.mmsi != null) {
          const lat = Number(data.latitude);
          const lon = Number(data.longitude);
          if (!inZone(lat, lon)) return;
          const key = String(data.mmsi);
          byMmsi.set(key, data);
          if (!vesselByMmsi.has(key) && !vesselFetchInFlight.has(key)) {
            vesselFetchInFlight.add(key);
            fetch(`/api/v1/vessels/${encodeURIComponent(key)}`)
              .then((res) => (res.ok ? res.json() : null))
              .then((vessel) => {
                if (vessel) {
                  vesselByMmsi.set(key, vessel);
                } else {
                  vesselByMmsi.set(key, {});
                }
              })
              .catch(() => {
                vesselByMmsi.set(key, {});
              })
              .finally(() => {
                vesselFetchInFlight.delete(key);
                render();
              });
          }
          render();
        }
      } catch (_) {
        // Ignore malformed events and keep stream alive.
      }
    };

    es.onerror = () => {
      setConnected(false);
    };
  </script>
</body>
</html>
